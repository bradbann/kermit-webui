{% extends "widgets/base_widget.html" %}
{% load i18n %}
{% block widget-content %}
<script>
	$(document).ready(function() {
		$("#dynagroup-dialog").hide();
		$("#context-execution-dialog").hide();
		$("#dynagroups").dynatree({
			title : "Dyna Groups",
			fx : {
				height : "toggle",
				duration : 200
			},
			autoFocus : false, // Set focus to first child, when expanding or lazy-loading.
			onCreate: function(node, span){
				//bindContextMenu(span);
      		},
			initAjax : {
				url : "{% url get_dynamicgroup_tree %}",
				data : {
					mode : "funnyMode"
				}
			},

			onQueryActivate : function(activate, node) {
				
				//        return false;
			},
			onActivate : function(node) {
				
			},
			onDeactivate : function(node) {
				logMsg("onDeactivate(%o)", node);
			},
			onQuerySelect : function(select, node) {
				logMsg("onQuerySelect(%o, %o)", select, node);
				if(node.data.isFolder)
					return false;
			},
			onSelect : function(select, node) {
				logMsg("onSelect(%o, %o)", node);
				var s = node.tree.getSelectedNodes().join(", ");
				$("#echoSelected").text(s);
			},
			onQueryExpand : function(expand, node) {
				logMsg("onQueryExpand(%o, %o)", expand, node);
				//        return false;
			},
			onExpand : function(expand, node) {
				logMsg("onExpand(%o, %o)", expand, node);
			},
			onFocus : function(node) {
				logMsg("onFocus(%o)", node);
				// Auto-activate focused node after 2 seconds
				node.scheduleAction("activate", 2000);
			},
			onBlur : function(node) {
				logMsg("onBlur(%o)", node);
				$("#echoFocused").text("-");
			},
			onClick : function(node, event) {
				logMsg("onClick(%o, %o)", node, event);
				
			},
			onDblClick : function(node, event) {
				logMsg("onDblClick(%o, %o)", node, event);
				node.toggleSelect();
			},
			onKeydown : function(node, event) {
				logMsg("onKeydown(%o, %o)", node, event);
				switch( event.which ) {
					case 32:
						// [space]
						node.toggleSelect();
						return false;
				}
			},
			onKeypress : function(node, event) {
				logMsg("onKeypress(%o, %o)", node, event);
			}
		});
		
		var content = $('#agentsSearch').val();

	    $('#dynagSearch').keyup(function() { 
	        if ($('#dynagSearch').val() != content) {
	            content = $('#dynagSearch').val();
	            filterTree(content, "dynagroups");
	        }
	    });
	    
		$("#addDynaGroup").click(function() {
			$.ajax({
				// The link we are accessing.
				url : "{% url get_dynamicgroup_form_no_param%}",
				// The type of request.
				type : "get",
				// The type of data that is getting returned.
				dataType : "html",
				error : function() {
					//TODO: Show error message
					//$('#loading').hide();
					showMessageDialog("{% trans 'Cannot get form. Error communicating with server' %}", "{% trans 'OK' %}");
				},
				beforeSend : function() {
					//$('#loading').show();
				},
				complete : function() {
					//$('#loading').hide();
				},
				success : function(data) {
					if(data != 'None') {
						$("#dynagroup-dialog").html(data);
						$("#dynagroup-dialog").dialog({
							modal : true,
							title : 'Dynamic Group',
							minHeight : 200,
							minWidth : 500
						});
						$("#dynagroup-dialog").show();
					} 
				}
			});
		}).mouseover(function() { 
            $(this).attr("src", "{{settings.STATIC_URL}}/images/expand_over.png");
        }).mouseout(function() {
            $(this).attr("src", "{{settings.STATIC_URL}}/images/expand.png");
        });
	});

</script>
<div id="context-execution-dialog"></div>
<div id="dynagroup-dialog"></div>
<img id="addDynaGroup" src="{{settings.STATIC_URL}}/images/expand.png" width="24" height="24"/>
<div id="filter">
	Filter: <input id="dynagSearch" type="text"/>
</div>
<div id="dynagroups"></div>
{% endblock %} 